<!DOCTYPE html>
<html>
<head>
	<title>Web</title>
	<script src="//cdn.rawgit.com/dcodeIO/protobuf.js/6.8.3/dist/protobuf.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/vue"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css" integrity="sha256-2k1KVsNPRXxZOsXQ8aqcZ9GOOwmJTMoOB5o5Qp1d6/s=" crossorigin="anonymous" />
	
</head>
<body>
	<div class="columns">
	  <div id="app-state" class="column">
	  	<pre>{{state}}</pre>
	  </div>
	  <div id="transactions" class="column">
	  	<ul>
	  		<li v-for="transaction in transactions">
	  			{{ transaction.toJSON() }}
	  		</li>
	  	</ul>
	  </div>
	</div>
	<script type="text/javascript" >
		socket = new WebSocket("ws://localhost:46657/websocket");
		var pending = {}, listeners = {}, nextId = 1, Transaction;
		socket.addEventListener('message', function(event) {
			var data = JSON.parse(event.data);
			console.log(JSON.stringify(data));
			if (Boolean(pending[data.id])) {
				pending[data.id](data.result);
				delete pending[data.id];
			}
			if (Boolean(listeners[data.id])) {
				listeners[data.id](data.result);
			}
		});

		var appState = new Vue({
			el: '#app-state',
			data: {
				state: {
					contracts: {}
				}
			}
		});
		var transactions = new Vue({
			el: '#transactions',
			data: {
				transactions: []
			}
		});
		function toHex(s) {
		    // utf8 to latin1
		    var s = unescape(encodeURIComponent(s))
		    var h = ''
		    for (var i = 0; i < s.length; i++) {
		        h += s.charCodeAt(i).toString(16)
		    }
		    return h
		}

		function fromHex(h) {
		    var s = ''
		    for (var i = 0; i < h.length; i+=2) {
		        s += String.fromCharCode(parseInt(h.substr(i, 2), 16))
		    }
		    return decodeURIComponent(escape(s))
		}
		function bufferToBase64(buf) {
			return btoa(String.fromCharCode.apply(null, buf))
		}
		function base64ToBuffer(base64str) {
			var rawStr = atob(base64str),
				buff = new Uint8Array(rawStr.length);
			for (var i = 0; i < rawStr.length; i += 1) {
				buff[i] = rawStr.charCodeAt(i);
			}
			return buff;
		}
		function genUUID() {
			// xx xx xx xx - xx xx - 4x xx - yx xx-xxxxxxxxxxxx
			var buf = new Uint8Array(16);
			for(var i = 0; i < 16; i ++) {
				buf[i] = (Math.random() * 256) | 0;
			}
			buf[6] = buf[6] & 0x0F | 0x40; // 0b0100xxxx
			buf[8] = buf[8] & 0x3F | 0x80; // 0b10xxxxxx
			return buf;
		}
		function createTransaction(data) {
			var t = Transaction.encode(data).finish();
			return bufferToBase64(t);
		}
		function doRequest(req, callback, event_listener) {
			if (socket.readyState == 0) {
				socket.addEventListener('open', function() {
					doRequest(req, callback, event_listener);
				});
			} else {
				let id = "request_" + String(nextId++);
				pending[id] = callback;
				req = {
					method: req.method,
					params: req.params,
					jsonrpc: "2.0",
					id: id
				};
				if (event_listener && req.method === 'subscribe') {
					listeners[id + "#event"] = event_listener;
				}
				console.log(JSON.stringify(req));
				socket.send(JSON.stringify(req));
			}
		};
		protobuf.load("transaction.proto", function(err, root) {
			Transaction = root.lookupType('Transaction');
			doRequest({
				method: 'subscribe',
				params: {
					query: "tm.event='Tx'"
				}
			}, function(data) {}, function(event) {
				var rawTx = event.data.data.tx;
				var transaction = Transaction.decode(base64ToBuffer(rawTx));
				transactions.transactions.unshift(transaction);

				
			});
			doRequest({
				method: 'abci_query',
				params: {
					path: 'state'
				}
			}, function(result) {
				console.log(fromHex(result.response.key));
				appState.state = JSON.parse(fromHex(result.response.value));
			});
		});
		
	</script>
</body>
</html>